name: Performance Benchmark

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  benchmark:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'

    # FIX: Start MinIO manually to ensure arguments are passed correctly
    - name: Start MinIO
      run: |
        docker run -d \
          --name minio \
          -p 9000:9000 \
          -e "MINIO_ROOT_USER=admin" \
          -e "MINIO_ROOT_PASSWORD=password" \
          minio/minio server /data
        
        # Wait for MinIO to be ready
        echo "Waiting for MinIO..."
        timeout 30s bash -c 'until curl --silent --fail http://localhost:9000/minio/health/live; do sleep 1; done'
        echo "MinIO is up!"

    - name: Setup MinIO Bucket
      run: |
        # Install mc (MinIO Client)
        curl -O https://dl.min.io/client/mc/release/linux-amd64/mc
        chmod +x mc
        ./mc alias set local http://localhost:9000 admin password
        ./mc mb local/velocity-cache

    - name: Build Velocity CLI & Server
      run: |
        go build -o velocity-cli ./cmd/velocity
        go build -o velocity-server ./cmd/server

    - name: Start Velocity Server (Background)
      env:
        VC_PORT: 8080
        VC_AUTH_TOKEN: secret123
        VC_STORAGE_DRIVER: s3
        VC_S3_BUCKET: velocity-cache
        VC_S3_REGION: us-east-1
        AWS_ACCESS_KEY_ID: admin
        AWS_SECRET_ACCESS_KEY: password
        AWS_REGION: us-east-1
        AWS_ENDPOINT_URL: http://localhost:9000
      run: |
        ./velocity-server &
        # Wait for server health check
        timeout 10s bash -c 'until curl --silent --fail http://localhost:8080/health; do sleep 1; done'
        echo "Velocity Server is up!"

    - name: Configure Velocity Client
      run: |
        cat <<EOF > velocity.yml
        version: 1
        project_id: "benchmark-ci"
        remote:
          enabled: true
          url: "http://localhost:8080"
          token: "secret123"
        pipeline:
          build:
            command: "echo 'Simulating Build...' && sleep 2 && mkdir -p dist && echo 'Artifact' > dist/out.txt"
            inputs: ["velocity.yml"]
            outputs: ["dist/**"]
            depends_on: []
        EOF

    - name: Run Cold Build (Cache Miss)
      run: |
        start_time=$(date +%s%3N)
        ./velocity-cli run build
        end_time=$(date +%s%3N)
        echo "COLD_TIME=$((end_time - start_time))" >> $GITHUB_ENV
        echo "Cold build finished."

    - name: Clean Local State
      run: |
        rm -rf dist .velocity

    - name: Run Warm Build (Cache Hit)
      run: |
        start_time=$(date +%s%3N)
        ./velocity-cli run build
        end_time=$(date +%s%3N)
        echo "WARM_TIME=$((end_time - start_time))" >> $GITHUB_ENV
        echo "Warm build finished."

    - name: Compare Results
      run: |
        echo "### VelocityCache Benchmark Results" >> $GITHUB_STEP_SUMMARY
        echo "| Type | Duration (ms) |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
        echo "| Cold Miss | $COLD_TIME ms |" >> $GITHUB_STEP_SUMMARY
        echo "| Warm Hit | $WARM_TIME ms |" >> $GITHUB_STEP_SUMMARY
        
        SPEEDUP=$(($COLD_TIME / $WARM_TIME))
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Speedup Factor:** ${SPEEDUP}x faster" >> $GITHUB_STEP_SUMMARY